name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    # ========== SETUP ENVIRONMENT ==========
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 11076708
        accept-android-sdk-licenses: true

    # ========== CONFIGURE BUILD ENVIRONMENT ==========
    - name: Install Required Android Components
      run: |
        sdkmanager "platforms;android-34"
        sdkmanager "platforms;android-26" 
        sdkmanager "build-tools;34.0.0"
        sdkmanager "extras;android;m2repository"
        sdkmanager "extras;google;m2repository"

    - name: Setup Gradle Caching
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make Gradle Wrapper Executable
      run: chmod +x ./gradlew

    # ========== PREPARE BUILD FILES ==========
    - name: Create Local Properties
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties

    - name: Create Environment File
      run: |
        echo "RAWG_API_KEY=${{ secrets.RAWG_API_KEY || '22413e93d24a4e05a6da4992ea2769ee' }}" > .env

    - name: Generate Debug Keystore
      run: |
        if [ ! -f app/debug.keystore ]; then
          keytool -genkey -v -keystore app/debug.keystore \
            -storepass android -alias androiddebugkey -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"
          echo "âœ… Debug keystore created"
        else
          echo "âœ… Debug keystore already exists"
        fi

    # ========== BUILD PROCESS ==========
    - name: Clean Project
      run: ./gradlew clean --stacktrace

    - name: Download Dependencies
      run: ./gradlew dependencies --stacktrace

    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace

    - name: Build Release APK
      run: ./gradlew assembleRelease --stacktrace
      continue-on-error: true

    # ========== UPLOAD ARTIFACTS ==========
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: GUA-Debug-APK
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 30

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      if: success() || failure()
      with:
        name: GUA-Release-APK
        path: app/build/outputs/apk/release/*.apk
        retention-days: 30
      continue-on-error: true

    # ========== BUILD SUMMARY ==========
    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸ“± Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f app/build/outputs/apk/debug/*.apk ]; then
          DEBUG_SIZE=$(du -h app/build/outputs/apk/debug/*.apk | cut -f1)
          echo "âœ… **Debug APK**: Built successfully ($DEBUG_SIZE)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Debug APK**: Build failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f app/build/outputs/apk/release/*.apk ]; then
          RELEASE_SIZE=$(du -h app/build/outputs/apk/release/*.apk | cut -f1)
          echo "âœ… **Release APK**: Built successfully ($RELEASE_SIZE)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Release APK**: Build failed or skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¥ **Download APKs from the Artifacts section above**" >> $GITHUB_STEP_SUMMARY